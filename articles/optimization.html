<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Optimization of APSIM NG using factorial simulations • rapsimng</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Optimization of APSIM NG using factorial simulations">
<meta property="og:description" content="rapsimng">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rapsimng</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/modify.html">Modify apsimx file</a>
    </li>
    <li>
      <a href="../articles/optimization.html">Optimization of APSIM NG using factorial simulations</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/byzheng/rapsimng/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="optimization_files/header-attrs-2.3/header-attrs.js"></script><script src="optimization_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Optimization of APSIM NG using factorial simulations</h1>
                        <h4 class="author">Bangyou Zheng</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/byzheng/rapsimng/blob/master/vignettes/optimization.Rmd"><code>vignettes/optimization.Rmd</code></a></small>
      <div class="hidden name"><code>optimization.Rmd</code></div>

    </div>

    
    
<p>Optimization of parameter values in the crop model is the key step to utilise models to simulate the field experiments. However, it is time consuming to calibrate lots of cultivars using observations from multiple experiments.</p>
<p>In this page, I presented a method using factorial simulations to calibrate and validate the leaf appearance process for wheat validation set in the <a href="https://github.com/APSIMInitiative/ApsimX/">APSIM Next Generation</a>. All 77 cultivars are simultaneously calibrated and validated in this process. The method heavily depends on the available CPU resources and infrastructure of cluster which might not be suitable for every situation. The codes in this page might not be reproducible.</p>
<p>The method of factorial simulations can be separated into multiple steps including</p>
<ul>
<li>Split apsimx into individual simulations for each treatment except cultivar factor.</li>
<li>Generate parameter spaces and prepare task list for parallel calculation.</li>
<li>Run tasks using cluster to obtain simulated values for factorial simulations.</li>
<li>Merge simulated values of all treatments for the target cultivars.</li>
<li>Calibrate and validate the leaf appearance process through comparing simulated and observed values.</li>
</ul>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># Load the required packages</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rapsimng</span>)
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>))</pre></body></html></div>
<div id="split-apsimx-into-individual-simulations" class="section level2">
<h2 class="hasAnchor">
<a href="#split-apsimx-into-individual-simulations" class="anchor"></a>Split apsimx into individual simulations</h2>
<p>Multiple experiments are used to test a crop model and organise into an apsimx file. It takes very long time to run a single apsimx file with lots of simulations (e.g. wheat.apsimx in the release contains more than 4000 simulations and takes more than 20 min to run all simulations). As we will run simulations in the parallel using multiple cores, the best practice is to split apsimx files into individual simulations.</p>
<p>The cultivars will be replaced with virtual cultivars (i.e. new values in the parameter spaces). The real cultivars in the experiment can be ignored. Consequently, we only need to run simulations for all treatments except cultivars.</p>
<p>In this step, I assume all datasets have been configured in a single apsimx file (e.g. <a href="https://raw.githubusercontent.com/APSIMInitiative/ApsimX/2a82f22208e1a9bd3d25b501457b43e507411b65/Tests/Validation/Wheat/Wheat.apsimx">Wheat.apsimx</a> in the APSIM NG Release). Experiments contain a factor Cv or Cultivar to specify all cultivars in the field experiments. All files are downloaded from internet.</p>
<p>The input is the wheatp.apsimx and associated weather files. The output is the split apsimx files merged with weather files and stored as Rds format.</p>
<p>APSIM NG provides a feature to generate .apsimx files from a single .apsim file through right clicking the root node.</p>
<p><img src="../../../../../../OneDrive%20-%20CSIRO/Working/04-Software/032-ApsimX/RApsimNG/vignettes/figures/apsimng-generate-simulations.png" width="40%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co"># Path to wheat.apsimx file</span>
<span class="no">file</span> <span class="kw">&lt;-</span> <span class="st">"Tests/Validation/Wheat/Wheat.apsimx"</span>
<span class="co"># Path to store the individual apsimx files</span>
<span class="no">out</span> <span class="kw">&lt;-</span> <span class="st">"Simulations/"</span>
<span class="co"># Factor in apsimx to specify cultivars</span>
<span class="no">cultivar_factor</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Cv"</span>, <span class="st">"Cultivar"</span>)

<span class="co"># read apsimx file</span>
<span class="no">apsimx_model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/read_apsimx.html">read_apsimx</a></span>(<span class="no">file</span>)

<span class="co"># Create a template</span>
<span class="no">apsimx_model_temp</span> <span class="kw">&lt;-</span> <span class="no">apsimx_model</span>
<span class="co"># Remove unused models to save spaces</span>
<span class="no">remove_nodes</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"[Simulations].Sensibility"</span>,
                  <span class="st">"[Simulations].Validation"</span>,
                  <span class="st">"[Simulations].TitlePage"</span>,
                  <span class="st">"[Simulations].Introduction"</span>,
                  <span class="st">"[DataStore].ExcelMultiInput"</span>,
                  <span class="st">"[DataStore].DailyObsPred"</span>,
                  <span class="st">"[DataStore].HarvestObsPred"</span>)
<span class="kw">for</span> (<span class="no">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="kw">along</span> <span class="kw">=</span> <span class="no">remove_nodes</span>)) {
  <span class="no">node_remove</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/search_path.html">search_path</a></span>(<span class="no">apsimx_model_temp</span>, <span class="no">remove_nodes</span>[<span class="no">j</span>])
  <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">node_remove</span>) <span class="kw">&gt;</span> <span class="fl">0</span>) {
    <span class="no">apsimx_model_temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/remove_model.html">remove_model</a></span>(<span class="no">apsimx_model_temp</span>, <span class="no">node_remove</span>$<span class="no">path</span>)
  }
}

<span class="co"># Get all simulations</span>
<span class="no">sims</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/search_node.html">search_node</a></span>(<span class="no">apsimx_model</span>, <span class="kw">all</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">`$type`</span> <span class="kw">=</span> <span class="st">"Models.Core.Simulation, Models"</span>)
<span class="no">sims</span> <span class="kw">&lt;-</span> <span class="no">sims</span> <span class="kw">%&gt;%</span> <span class="fu">discard</span>(<span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>$<span class="no">node</span>$<span class="no">Name</span> <span class="kw">==</span> <span class="st">"CO2TEBaseSimulation"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu">map_chr</span>(<span class="no">sims</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>$<span class="no">node</span>$<span class="no">Name</span>))

<span class="co"># Process each simulation by splitting into individual treatment if parent is Experiment or directly exporting in case of single simulation.</span>
<span class="kw">for</span> (<span class="no">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="kw">along</span> <span class="kw">=</span> <span class="no">sims</span>)) {
  <span class="co"># Check whether the parent is experiment</span>
  <span class="no">parent</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/get_parent.html">get_parent</a></span>(<span class="no">apsimx_model</span>, <span class="no">sims</span><span class="kw">[[</span><span class="no">j</span>]]$<span class="no">path</span>)
  <span class="kw">if</span> (<span class="no">parent</span>$<span class="no">node</span>$<span class="no">`$type`</span> <span class="kw">==</span> <span class="st">"Models.Factorial.Experiment, Models"</span>) {
    <span class="no">exp_node</span> <span class="kw">&lt;-</span> <span class="no">parent</span>$<span class="no">node</span>
    <span class="no">exp_name</span> <span class="kw">&lt;-</span> <span class="no">exp_node</span>$<span class="no">Name</span>
    <span class="co"># Remove all figures as we don't need them</span>
    <span class="no">graphs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/search_node.html">search_node</a></span>(<span class="no">exp_node</span>, <span class="kw">all</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                          <span class="kw">`$type`</span> <span class="kw">=</span> <span class="st">"Models.Graph, Models"</span>)
    <span class="kw">for</span> (<span class="no">k</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="kw">along</span> <span class="kw">=</span> <span class="no">graphs</span>))) {
      <span class="no">exp_node</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/remove_model.html">remove_model</a></span>(<span class="no">exp_node</span>, <span class="no">graphs</span><span class="kw">[[</span><span class="no">k</span>]]$<span class="no">path</span>)
    }
    <span class="co"># Remove unused reports</span>
    <span class="no">remove_nodes</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"[DailyReport]"</span>,
                      <span class="st">"[MaxLeafSizeReport]"</span>,
                      <span class="st">"[SowingReport]"</span>)
    <span class="kw">for</span> (<span class="no">k</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="kw">along</span> <span class="kw">=</span> <span class="no">remove_nodes</span>)) {
      <span class="no">node_remove</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/search_path.html">search_path</a></span>(<span class="no">exp_node</span>, <span class="no">remove_nodes</span>[<span class="no">k</span>])
      <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">node_remove</span>) <span class="kw">&gt;</span> <span class="fl">0</span>) {
        <span class="no">exp_node</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/remove_model.html">remove_model</a></span>(<span class="no">exp_node</span>, <span class="no">node_remove</span>$<span class="no">path</span>)
      }
    }
    <span class="co"># Create a new apsimx file from template</span>
    <span class="no">apsimx_model_exp</span> <span class="kw">&lt;-</span> <span class="no">apsimx_model_temp</span>
    <span class="no">apsimx_model_exp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/insert_model.html">insert_model</a></span>(<span class="no">apsimx_model_exp</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>), <span class="no">exp_node</span>)
    <span class="co"># Get the met files</span>
    <span class="no">met</span> <span class="kw">&lt;-</span> <span class="kw">NULL</span>
    <span class="no">met_file</span> <span class="kw">&lt;-</span> <span class="kw">NULL</span>
    <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({
      <span class="no">met_file</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/get_metfile.html">get_metfile</a></span>(<span class="no">apsimx_model_exp</span>)
      <span class="no">met_path</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/basename.html">dirname</a></span>(<span class="no">file</span>), <span class="no">met_file</span>)
      <span class="no">met</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(<span class="no">met_path</span>)
    }, <span class="kw">error</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">e</span>){

    })
    <span class="co"># Further split apsimx by all factors except Cv</span>
    <span class="no">all_nodes</span> <span class="kw">&lt;-</span> <span class="no">apsimx_model_exp</span> <span class="kw">%&gt;%</span>
      <span class="fu"><a href="../reference/search_path.html">search_path</a></span>(<span class="st">"[Factors]"</span>)

    <span class="co"># find out all combinations of all other nodes</span>
    <span class="no">simulations</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/get_simulations.html">get_simulations</a></span>(<span class="no">all_nodes</span>$<span class="no">node</span>)

    <span class="co"># Check whether Cv node exists</span>
    <span class="no">pos</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">simulations</span>) <span class="kw">%in%</span> <span class="no">cultivar_factor</span>
    <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">pos</span>) <span class="kw">==</span> <span class="fl">0</span>) {
      <span class="fu"><a href="https://rdrr.io/r/base/warning.html">warning</a></span>(<span class="st">"Cultivar factor doesn't exist for experiment "</span>, <span class="no">exp_name</span>)
      <span class="co">#next()</span>
    }
    <span class="co"># Generate all simulations for factors except cultivar</span>
    <span class="no">simulations</span> <span class="kw">&lt;-</span> <span class="no">simulations</span>[!(<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">simulations</span>) <span class="kw">%in%</span> <span class="no">cultivar_factor</span>)]
    <span class="no">simulations</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span>(<span class="no">simulations</span>, <span class="kw">stringsAsFactors</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
    <span class="co"># Generate apsimx for each factor</span>
    <span class="kw">for</span> (<span class="no">m</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">simulations</span>)))) {
      <span class="co"># In case of single simulation</span>
      <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">simulations</span>) <span class="kw">==</span> <span class="fl">0</span>) {
        <span class="no">model_factor_new</span> <span class="kw">&lt;-</span> <span class="no">all_nodes</span>$<span class="no">node</span>
        <span class="no">base_name</span> <span class="kw">&lt;-</span> <span class="no">exp_name</span>
      } <span class="kw">else</span> {
        <span class="co"># Keep the required factor</span>
        <span class="no">model_factor_new</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/keep_simulations.html">keep_simulations</a></span>(<span class="no">all_nodes</span>$<span class="no">node</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="no">simulations</span>[<span class="no">m</span>,,<span class="kw">drop</span><span class="kw">=</span><span class="fl">FALSE</span>]))
        <span class="no">factor_name</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">simulations</span>), <span class="st">"_"</span>, <span class="no">simulations</span>[<span class="no">m</span>,]), <span class="kw">collapse</span> <span class="kw">=</span> <span class="st">'_'</span>)
        <span class="no">base_name</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">exp_name</span>, <span class="st">"-"</span>, <span class="no">factor_name</span>)
      }
      <span class="co"># Generate a new apsimx</span>
      <span class="no">apsimx_model_new</span> <span class="kw">&lt;-</span> <span class="no">apsimx_model_exp</span>
      <span class="no">apsimx_model_new</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/replace_model.html">replace_model</a></span>(<span class="no">apsimx_model_exp</span>,
                                        <span class="no">all_nodes</span>$<span class="no">path</span>,
                                        <span class="no">model_factor_new</span>)

      <span class="co"># Combine weather and met file</span>
      <span class="co">#apsimx &lt;- readLines(file_name)</span>
      <span class="no">file_name</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">out</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">base_name</span>, <span class="st">".Rds"</span>))
      <span class="co"># Find the weather file</span>
      <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">met</span>)) {
        <span class="no">treat_node</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/search_path.html">search_path</a></span>(<span class="no">apsimx_model_new</span>, <span class="st">"[Permutation].Treat"</span>)
        <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">treat_node</span>) <span class="kw">&gt;</span> <span class="fl">0</span>) {
          <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">treat_node</span>$<span class="no">node</span>$<span class="no">Children</span>) <span class="kw">&gt;</span> <span class="fl">1</span> ){
            <span class="fu"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>()
          }
          <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">treat_node</span>$<span class="no">node</span>$<span class="no">Children</span><span class="kw">[[</span><span class="fl">1</span>]]$<span class="no">Children</span>) <span class="kw">&gt;</span> <span class="fl">0</span>) {
            <span class="no">met_file</span> <span class="kw">&lt;-</span> <span class="no">treat_node</span>$<span class="no">node</span>$<span class="no">Children</span><span class="kw">[[</span><span class="fl">1</span>]]$<span class="no">Children</span><span class="kw">[[</span><span class="fl">1</span>]]$<span class="no">FileName</span>
            <span class="no">met_path</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/basename.html">dirname</a></span>(<span class="no">file</span>), <span class="no">met_file</span>)
            <span class="no">new_met</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(<span class="no">met_path</span>)
          } <span class="kw">else</span> {
            <span class="no">new_met</span> <span class="kw">&lt;-</span> <span class="kw">NULL</span>
          }
        }
      } <span class="kw">else</span> {
        <span class="no">new_met</span> <span class="kw">&lt;-</span> <span class="no">met</span>
      }
      <span class="co"># Save weather and apsimx file into Rds format</span>
      <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">met</span> <span class="kw">=</span> <span class="no">new_met</span>, <span class="kw">apsimx</span> <span class="kw">=</span> <span class="no">apsimx_model_new</span>, <span class="kw">met_file</span> <span class="kw">=</span> <span class="no">met_file</span>), <span class="kw">file</span> <span class="kw">=</span> <span class="no">file_name</span>)
    }
  } <span class="kw">else</span> {
    <span class="co"># In case of single simulation</span>
    <span class="no">apsimx_model_new</span> <span class="kw">&lt;-</span> <span class="no">apsimx_model_temp</span>
    <span class="no">apsimx_model_new</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/insert_model.html">insert_model</a></span>(<span class="no">apsimx_model_new</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>), <span class="no">sims</span><span class="kw">[[</span><span class="no">j</span>]]$<span class="no">node</span>)

    <span class="co"># Get weather data</span>
    <span class="no">met</span> <span class="kw">&lt;-</span> <span class="kw">NULL</span>
    <span class="no">met_file</span> <span class="kw">&lt;-</span> <span class="kw">NULL</span>
    <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>({
      <span class="no">met_file</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/get_metfile.html">get_metfile</a></span>(<span class="no">apsimx_model_new</span>)
      <span class="no">met_path</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/basename.html">dirname</a></span>(<span class="no">file</span>), <span class="no">met_file</span>)
      <span class="no">met</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(<span class="no">met_path</span>)
    }, <span class="kw">error</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">e</span>){

    })

    <span class="co"># Save weather and apsimx file into Rds format</span>
    <span class="no">base_name</span> <span class="kw">&lt;-</span> <span class="no">sims</span><span class="kw">[[</span><span class="no">j</span>]]$<span class="no">node</span>$<span class="no">Name</span>
    <span class="no">file_name</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">out</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">base_name</span>, <span class="st">".Rds"</span>))
    <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">met</span> <span class="kw">=</span> <span class="no">met</span>, <span class="kw">apsimx</span> <span class="kw">=</span> <span class="no">apsimx_model_new</span>, <span class="kw">met_file</span> <span class="kw">=</span> <span class="no">met_file</span>), <span class="kw">file</span> <span class="kw">=</span> <span class="no">file_name</span>)

  }
}</pre></body></html></div>
<p>Finally wheat.apsimx is split into 885 treatments.</p>
</div>
<div id="generate-the-parameter-spaces-and-prepare-the-task-list-for-parallel-calculation" class="section level2">
<h2 class="hasAnchor">
<a href="#generate-the-parameter-spaces-and-prepare-the-task-list-for-parallel-calculation" class="anchor"></a>Generate the parameter spaces and prepare the task list for parallel calculation</h2>
<p>In this page, we will optimize two parameters in the leaf appearance rate i.e. base phyllochron (<code>[Phenology].Phyllochron.BasePhyllochron.FixedValue</code>) and photoperiod effect (<code>[Phenology].Phyllochron.PhotoPeriodEffect.XYPairs.Y</code>). The parameter range is determined by expert experience or possible values in the current wheat model. The internal should make sure there are enough accuracy for the target traits.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co"># Define list of parameter with specified range and interval</span>
<span class="co"># Expand grid for all combinations</span>
<span class="no">parameters</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">`[Phenology].Phyllochron.BasePhyllochron.FixedValue`</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">60</span>, <span class="fl">130</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="fl">1</span>)),
          <span class="kw">`[Phenology].Phyllochron.PhotoPeriodEffect.XYPairs.Y`</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fl">2</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="fl">0.02</span>), <span class="st">",1,1"</span>)) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span>()</pre></body></html></div>
<p>A single simulation takes less than 1 s to run in the APSIM GUI (APSIMNG.exe), but about 5 s in the command lines (Modeles.exe) as the overhead to load all required libraries. It would be much more efficient to combine multiple simulations in a single apsimx file (e.g. 200 simulations take about 150 s).</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># Define the group size in a single apsimx file</span>
<span class="no">size</span> <span class="kw">&lt;-</span> <span class="fl">200</span>

<span class="co"># Calculate the number of groups</span>
<span class="no">group</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">parameters</span>)/<span class="no">size</span>))

<span class="co"># Create names for each virtual cultivar</span>
<span class="co"># Assign the group value</span>
<span class="no">parameters</span> <span class="kw">&lt;-</span> <span class="no">parameters</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">name</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"GS"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="fu">n</span>()), <span class="st">"GN"</span>),
         <span class="kw">group</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="no">group</span>, <span class="kw">each</span> <span class="kw">=</span> <span class="no">size</span> ,
                      <span class="kw">length.out</span> <span class="kw">=</span> <span class="fu">n</span>())) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="fu">starts_with</span>(<span class="st">"["</span>), <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"parameter"</span>)

<span class="co"># The parameters can be stored for later use, but ignore for this post</span>
<span class="co"># saveRDS(parameters, file = "parameters.Rds)</span>
<span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">parameters</span>), <span class="kw">caption</span> <span class="kw">=</span> <span class="st">"Sample of parameters"</span>)</pre></body></html></div>
<table class="table">
<caption>Sample of parameters</caption>
<thead><tr class="header">
<th align="left">name</th>
<th align="right">group</th>
<th align="left">parameter</th>
<th align="left">value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">GS1GN</td>
<td align="right">1</td>
<td align="left">[Phenology].Phyllochron.BasePhyllochron.FixedValue</td>
<td align="left">60</td>
</tr>
<tr class="even">
<td align="left">GS1GN</td>
<td align="right">1</td>
<td align="left">[Phenology].Phyllochron.PhotoPeriodEffect.XYPairs.Y</td>
<td align="left">1,1,1</td>
</tr>
<tr class="odd">
<td align="left">GS2GN</td>
<td align="right">1</td>
<td align="left">[Phenology].Phyllochron.BasePhyllochron.FixedValue</td>
<td align="left">61</td>
</tr>
<tr class="even">
<td align="left">GS2GN</td>
<td align="right">1</td>
<td align="left">[Phenology].Phyllochron.PhotoPeriodEffect.XYPairs.Y</td>
<td align="left">1,1,1</td>
</tr>
<tr class="odd">
<td align="left">GS3GN</td>
<td align="right">1</td>
<td align="left">[Phenology].Phyllochron.BasePhyllochron.FixedValue</td>
<td align="left">62</td>
</tr>
<tr class="even">
<td align="left">GS3GN</td>
<td align="right">1</td>
<td align="left">[Phenology].Phyllochron.PhotoPeriodEffect.XYPairs.Y</td>
<td align="left">1,1,1</td>
</tr>
</tbody>
</table>
</div>
<div id="run-all-tasks-in-cluster-to-collect-results" class="section level2">
<h2 class="hasAnchor">
<a href="#run-all-tasks-in-cluster-to-collect-results" class="anchor"></a>Run all tasks in cluster to collect results</h2>
<p>This step is time-consuming and depends on the available CPUs. The total runtime can be calculated by number of treatments x number of virtual genotype groups x runtime of individual task / available CPUs. I used HTCondor deployed in CSIRO in which there are more 10, 000 available cores, but can normally utilize 5, 000 cores. The inputs below can be used to calculate the total runtime.</p>

<div class="input-group input-group-sm mb-3">
  <div class="input-group-prepend col-5">
    <span class="input-group-text col-12">Number of treatments</span>
  </div>
  <input name="total-run-time" type="text" id="treatments" value="885" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm">
</div>
<div class="input-group input-group-sm mb-3">
  <div class="input-group-prepend col-5">
    <span class="input-group-text col-12">Number of genotype groups</span>
  </div>
  <input name="total-run-time" type="text" id="genotype-groups" value="37" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm">
</div>
<div class="input-group input-group-sm mb-3">
  <div class="input-group-prepend col-5">
    <span class="input-group-text col-12">Runtime of individual task</span>
  </div>
  <input name="total-run-time" type="text" id="runtime-individual" value="150" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm"><div class="input-group-append">
    <span class="input-group-text">seconds</span>
  </div>
</div>
<div class="input-group input-group-sm mb-3">
  <div class="input-group-prepend col-5">
    <span class="input-group-text col-12">Available CPUs</span>
  </div>
  <input name="total-run-time" type="text" id="cpus" value="5000" class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm">
</div>
<div class="input-group input-group-sm mb-3">
  <div class="input-group-prepend col-5">
    <span class="input-group-text col-12">Total runtime</span>
  </div>
  <input name="total-run-time" type="text" id="final-runtime" class="form-control" aria-label="Small" disabled aria-describedby="inputGroup-sizing-sm"><div class="input-group-append">
    <span class="input-group-text">hours</span>
  </div>
</div>

<script type="text/javascript">
$( document ).ready(function() {
  var cal_runtime = function() {
    let n_treatments = parseFloat($("#treatments").val());
    let n_genotype_group = parseFloat($("#genotype-groups").val());
    let individual_runtime = parseFloat($("#runtime-individual").val());
    let n_cpus = parseFloat($("#cpus").val());
    let final_runtime = n_treatments * n_genotype_group * individual_runtime / n_cpus / 3600;
    $("#final-runtime").val(final_runtime);
  }
  cal_runtime();
  $("input[name='total-run-time']").change(function() {
      cal_runtime();
  });
});
</script><div id="develop-scripts-to-run-individual-task-on-htcondor" class="section level3">
<h3 class="hasAnchor">
<a href="#develop-scripts-to-run-individual-task-on-htcondor" class="anchor"></a>Develop scripts to run individual task on HTCondor</h3>
</div>
</div>
<div id="merge-all-results-for-each-individual-experiment" class="section level2">
<h2 class="hasAnchor">
<a href="#merge-all-results-for-each-individual-experiment" class="anchor"></a>Merge all results for each individual experiment</h2>
</div>
<div id="merge-all-results-for-each-individual-genotype" class="section level2">
<h2 class="hasAnchor">
<a href="#merge-all-results-for-each-individual-genotype" class="anchor"></a>Merge all results for each individual genotype</h2>
</div>
<div id="optimize-the-genotypic-parameters-for-each-genotype" class="section level2">
<h2 class="hasAnchor">
<a href="#optimize-the-genotypic-parameters-for-each-genotype" class="anchor"></a>Optimize the genotypic parameters for each genotype</h2>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Bangyou Zheng.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
